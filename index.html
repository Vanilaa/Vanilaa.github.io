<h1 id="dashboard-decor">Dashboard Decor</h1>
<p>This project is managed by Yaqi (yg298) and Alina (lw584) during Fall 2023 and demonstrate on 12/7/2023.</p>
<center><img src="/img/grouppic.jpg" width="300" height="400"></center>

<h2 id="objective">Objective</h2>
<p>In this project, we want to make our home or study area more comfortable, creating this safe space where we would
    love to study or live in, therefore we came up with the idea of creating a desktop gadget. We envision this to be a
    versatile, fun, and aesthetic decor for someone who is into Pixel art. This dashboard will combine different
    functionalities like controlling Spotify song playback, playing drawing and guessing game, entering Zen mode with
    weather forecast, and displaying cute animations</p>
<center><img src="C:/Users/wangl/Downloads/5725final/img/welcome.png" width="400" height="320"></center>

<h2 id="introduction">Introduction</h2>
<p>We imagine this dashboard to be like a small widget where the user will be able to check for the current date, time,
    a short greeting based on the time of the day, current weather conditions, temperature/humidity, and sunrise/sunset
    time. For other interactive functions, we want it to be able to connect to the user’s Spotify account so it can
    control the playlist, skip back and forth in the playlist, and display the album cover. We also want to add a game
    to the dashboard, at first we wanted to implement Dianasour’s Jumping game in Google, but the LED panel’s pitch is
    too large and the animation on it doesn’t look very good, so we pivoted to a drawing game in which the player can
    either play with a friend, or it can be single player and just let the LED display the artwork user draws.</p>
<p>In terms of the technical components involved in implementation, we want to make use of the PyGame library and TFT
    screen as we have learned during this semester’s lab sections. Those hardware and software can be customized in so
    many different ways, giving us many options of how to use them. We also wanted to explore aspects of human-centered
    deisgn, since this is a highly interactive project. In addition, we want to try out some additional hardware like
    LED Panel and learn to access external APIs for real-time data and HTTP requests.</p>
<h2 id="design-and-testing">Design and Testing</h2>
<p>We followed modular design principles throughout the project. </p>
<center><img src="/img/page.jpg" width="850" height="340"></center>

<h3 id="led-panel">LED Panel</h3>
<h4 id="wiring">Wiring</h4>
<p>To wire up the LED panel to Raspberry Pi, we referenced the pinouts described in Adafruit&#39;s <a
        href="https://learn.adafruit.com/adafruit-rgb-matrix-bonnet-for-raspberry-pi/pinouts">RGB matrix bonnet
        tutorial</a>. </p>
<table>
    <thead>
        <tr>
            <th>left</th>
            <th>right</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>LED# - Func - GPIO</td>
            <td>LED# - Func - GPIO</td>
        </tr>
        <tr>
            <td>1-R1-5</td>
            <td>9-G1-13</td>
        </tr>
        <tr>
            <td>2-B1-6</td>
            <td>10-GND-GND</td>
        </tr>
        <tr>
            <td>3-R2-12</td>
            <td>11-G2-16</td>
        </tr>
        <tr>
            <td>4-B2-23</td>
            <td>12-E-24</td>
        </tr>
        <tr>
            <td>5-A-22</td>
            <td>13-B-26</td>
        </tr>
        <tr>
            <td>6-C-27</td>
            <td>14-D-20</td>
        </tr>
        <tr>
            <td>7-CLK-17</td>
            <td>15-LAT-21</td>
        </tr>
        <tr>
            <td>8-OE-4</td>
            <td>16-GND-GND</td>
        </tr>
    </tbody>
</table>
<p>We also check to make sure that the GPIO pins used for the LED panel does not overlap pins used by TFT. It does
    turnout that the GPIO pins connected to the buttons on the TFT screen is used by the LED panel. Therefore we
    incorporated an external button to function as the quit button. </p>
<h4 id="installing-library-and-running-provided-examples">Installing library and running provided examples</h4>
<p>We took advantage of hzeller&#39;s <a href="https://github.com/hzeller/rpi-rgb-led-matrix">Raspberry Pi RGB matrix
        library</a> to control the LED panel with Raspberry Pi. After installing the library, we tried running a few
    example, with flags <code>--led-cols=64 --led-rows=32</code>We observed some issues, where the bottom half of the
    panel does not light up at all, and we couldn&#39;t really tell what is on the top half, which looks like it is
    glitching. So we went back to double check our wiring and configuration. We found a misplaced wire for the matrix E
    pin. Plugging it in the right place gives us pixels lighting up on the bottom half. We then found suggestions in the
    tutorial that with Pi 4, the matrix control speed needs to be dialed back slightly. We changed the
    <code>--led-slowdown-gpio</code> setting to 4, which fixed the glitches.
</p>
<h4 id="creating-views-individually">Creating views individually</h4>
<p>We study the examples that came with the library to understand the flow of projecting an image to the LED panel.
    There are three steps in preparing an image: importing, resizing, and converting format to RGB. We also explored
    playing animations on the panel by importing gif, process each frame, adding all the frames to a list, loop over the
    frames and display them on the panel one after the other. We also discovered that the library came with an abundant
    set of fonts available for use, which allow us to display text on the LED panel.</p>
<p>To allow the user to create their own art piece with this panel, we mapped each pixel drawn on the piTFT screens to a
    position on the LED screen, store the RGB values in a 2D matrix, loop through the matrix and set each Pixel
    individually. </p>
<h5 id="spotify">Spotify</h5>
<p>Upon entering music player mode, the album cover of the current track is downloaded and stored in
    <code>album_cover.jpg</code>. We were careful to make sure that we do not always have to download the cover at each
    update of the frame, since it takes some time for download to complete. The cover is then resized and displayed on
    the LED panel, along with name of the track and the artist.
</p>
<center><img src="/img/spotify.png" width="400" height="320"></center>

<h5 id="drawing">Drawing</h5>
<p>To allow the user to create their own art piece with this panel, we mapped each pixel drawn on the piTFT screens to a
    position on the LED screen, store the RGB values in a 2D matrix, loop through the matrix and set each Pixel
    individually.</p>
<center><img src="/img/draw.JPG" width="300" height="420"></center>

<h5 id="weather">Weather</h5>
<p>The weather screen displays a weather animation which is done by isolating each frame of a weather gif and displaying
    them in a loop to create the animated effect. On top of the weather animation, we will display the weather
    information obtained by requesting from an Open API, described below.</p>
<h4 id="accessing-real-time-weather-information-with-api">Accessing real-time weather information with API</h4>
<p>For real-time weather info, we decided to use Open Weather API which allows us to make HTTP requests hourly to get
    accurate weather information.</p>
<p>We store the weather info as a JSON file since it&#39;s long and detailed. We only needed a few information like
    weather condition, temperature, and humidity. Therefore, we can index into the JSON, pull the information out from
    the JSON file, and display it on top of the animation frames.</p>
<center><img src="/img/weather.png" width="400" height="320"></center>

<h3 id="tft-screen">TFT Screen</h3>
<h4 id="installing-and-testing-spotipy-library">Installing and testing Spotipy library</h4>
<p>The <a href="https://spotipy.readthedocs.io/en/2.22.1/">Spotipy</a> library is a lightweight python library for the
    <a href="https://developer.spotify.com/documentation/web-api">Spotify Web API</a>. It has the capability of
    accessing authorized user’s playlist, devices and controlling playback on the devices by sending http requests and
    receiving http responses.
    We followed the example on Spotipy documentation and first created and testsed a simple python script to control
    playback on our personal device through command line. We then organized the code into functions and created our own
    <code>my_spotify</code> library. The library has four functions: initialize, download album cover, add playlist to
    queue, and fetch current playback’s track title and artist.
</p>
<h4 id="creating-user-interfaces-with-pygame">Creating user interfaces with Pygame</h4>
<h5 id="home-screen">Home Screen</h5>
<p>Three icons are centered on the TFT home page: spotify, draw, and weather. Each icon will direct the user to the
    corresponding page. For implementation, we created these Pygame rects and detected mouse collision with the rects.
    After switching to the other screen, we will use the pygame’s clear function to clean it.</p>
<h5 id="drawing">Drawing</h5>
<p>For the drawing screen, we want to have a color palette screen where the user can change the color of the paintbrush
    and a drawing area. Therefore we have 2 main Pygame screens, the color palette consists of the color circles which
    detects mouse collision to determine which color the user is trying to change to. The drawing screen will blit all
    the pixel user drawn on it and append the pixel’s coordinate to an RGB matrix which will be mapped to the LED screen
    at the same time. Therefore, both TFT and LED screens will be able to see the drawing live-time. </p>
<h3 id="other">Other</h3>
<h4 id="spotifyd">Spotifyd</h4>
<p>We also followed a Youtube tutorial on <a href="https://www.youtube.com/watch?v=GGXJuzSise4">how to turn Raspberry Pi
        device into a device on Spotify account</a></p>
<p>Mainly, we added a config file in which we specify the Spotify account logins and added the device we wanted to use
    to play music which is RPi. </p>
<h2 id="result">Result</h2>
<iframe width="500" height="295" src="https://www.youtube.com/embed/et91Gea6CPk?rel=0" frameborder="0"
    allow="autoplay; encrypted-media" allowfullscreen></iframe>

<h2 id="conclusion">Conclusion</h2>
<p>We successfully achieved 90% of the functionality we proposed in our proposal and substituted the 10% with
    functionalities we thought would be more fun to implement as we worked on it. We were able to solve most of the bugs
    and we pushed through the project even when we lost all of our files when crontab messed up.
    We found out that due to Spotify’s security policy, we won’t be able to use Crontab, since it requires Spotify
    authorization after each reboot or shutdown. We also learned more about how to restore files if Crontab didn’t
    function properly, and always backup or at least download our files before reboot. </p>
<h2 id="future-work">Future Work</h2>
<p>There are still a lot to do if we want to improve this project.</p>
<ol>
    <li>We can clean up the wires and build a display case for it</li>
    <li>Add the functionality to save user&#39;s artwork</li>
    <li>Scrolling song title and artist name when they are too long. </li>
</ol>
<h2 id="budget">Budget</h2>
<table>
    <thead>
        <tr>
            <th style="text-align:left">Part</th>
            <th style="text-align:left">Quantity</th>
            <th style="text-align:left">Our Cost</th>
            <th style="text-align:left">Actual Cost</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td style="text-align:left">RPi</td>
            <td style="text-align:left">1</td>
            <td style="text-align:left">0</td>
            <td style="text-align:left">45</td>
        </tr>
        <tr>
            <td style="text-align:left">TFT screen</td>
            <td style="text-align:left">1</td>
            <td style="text-align:left">0</td>
            <td style="text-align:left">45</td>
        </tr>
        <tr>
            <td style="text-align:left">Button</td>
            <td style="text-align:left">1</td>
            <td style="text-align:left">0</td>
            <td style="text-align:left">0.5</td>
        </tr>
        <tr>
            <td style="text-align:left">LED Panel</td>
            <td style="text-align:left">2</td>
            <td style="text-align:left">0</td>
            <td style="text-align:left">45</td>
        </tr>
        <tr>
            <td style="text-align:left">5V 4A adapter</td>
            <td style="text-align:left">1</td>
            <td style="text-align:left">0</td>
            <td style="text-align:left">0</td>
        </tr>
        <tr>
            <td style="text-align:left">Jump wires</td>
            <td style="text-align:left">a handful</td>
            <td style="text-align:left">0</td>
            <td style="text-align:left">0</td>
        </tr>
    </tbody>
</table>
<p>Total: $135.5</p>
<h2 id="reference">Reference</h2>
<h3 id="libraries">Libraries</h3>
<ol>
    <li>pygame</li>
    <li>spotipy</li>
    <li>spotifyd</li>
    <li>rpi-rgb-led-marix</li>
</ol>
<h3 id="tutorials-guides">Tutorials/Guides</h3>
<p>These are linked though out the webpage for seamless reading.</p>
<h3 id="code-appendix">Code Appendix</h3>
<p>Below is our master code where we integrated everything.</p>
<pre><code class="lang-python">################### Libraries ###########################
<span class="hljs-keyword">from</span> samplebase <span class="hljs-keyword">import</span> SampleBase
<span class="hljs-keyword">from</span> rgbmatrix <span class="hljs-keyword">import</span> graphics
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> ImageSequence
<span class="hljs-keyword">import</span> pygame
<span class="hljs-keyword">import</span> my_spotify
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> RPi.GPIO <span class="hljs-keyword">as</span> GPIO
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> my_spotify
<span class="hljs-keyword">import</span> json

#################### Setup Environment ##################
os.putenv(<span class="hljs-string">'SDL_VIDEODRIVER'</span>, <span class="hljs-string">'fbcon'</span>)
os.putenv(<span class="hljs-string">'SDL_FBDEV'</span>, <span class="hljs-string">'/dev/fb0'</span>) 
os.putenv(<span class="hljs-string">'SDL_MOUSEDRV'</span>, <span class="hljs-string">'TSLIB'</span>) # Track mouse clicks on piTFT
os.putenv(<span class="hljs-string">'SDL_MOUSEDEV'</span>, <span class="hljs-string">'/dev/input/touchscreen'</span>)

print(<span class="hljs-string">"start"</span>)

print(<span class="hljs-string">"init"</span>)
pygame.init()
TFT_SIZE = width, height = <span class="hljs-number">320</span>, <span class="hljs-number">240</span>
print(<span class="hljs-string">"setmode"</span>)
screen = pygame.display.set_mode(TFT_SIZE)

################## Constants ############################



print(<span class="hljs-string">"initializing spotify"</span>)
# initialize spotify
sp = my_spotify.spotify_init()
my_spotify.add_playlist_to_queue(sp)
print(<span class="hljs-string">"finished initializing spotify"</span>)

# pygame colors
BLACK = <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
WHITE = <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>
RED = <span class="hljs-number">252</span>, <span class="hljs-number">65</span>, <span class="hljs-number">3</span>
ORANGE = <span class="hljs-number">252</span>, <span class="hljs-number">154</span>, <span class="hljs-number">48</span>
GREEN = <span class="hljs-number">111</span>, <span class="hljs-number">224</span>, <span class="hljs-number">101</span>
BLUE = <span class="hljs-number">3</span>, <span class="hljs-number">148</span>, <span class="hljs-number">252</span>
PURPLE = <span class="hljs-number">209</span>, <span class="hljs-number">109</span>, <span class="hljs-number">227</span>
GREY = <span class="hljs-number">128</span>, <span class="hljs-number">128</span>, <span class="hljs-number">128</span>

led_white = graphics.Color(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>)



############## GLOBAL VARIABLES ###################
code_run = <span class="hljs-literal">True</span>
is_home = <span class="hljs-literal">True</span>
is_music_player = <span class="hljs-literal">False</span>
is_scribble = <span class="hljs-literal">False</span>
is_weather = <span class="hljs-literal">False</span>
playing = <span class="hljs-literal">False</span>
drawing = <span class="hljs-literal">True</span>
brush_color = WHITE

################### TFT ###########################

print(<span class="hljs-string">"setup pygame"</span>)


# setup pygame on tft
screen.fill(BLACK)

# surfaces and icons
spotify_surface = pygame.Surface(TFT_SIZE)
home_surface = pygame.Surface(TFT_SIZE)


spotify_icon = pygame.image.load(<span class="hljs-string">"img/spotify_icon.png"</span>)
spotify_icon = pygame.transform.scale(spotify_icon, (<span class="hljs-number">50</span>,<span class="hljs-number">50</span>))
spotify_rect = spotify_icon.get_rect().move((<span class="hljs-number">40</span>,<span class="hljs-number">120</span>))

scribble_icon = pygame.image.load(<span class="hljs-string">"img/scribble.png"</span>)
scribble_icon = pygame.transform.scale(scribble_icon, (<span class="hljs-number">50</span>,<span class="hljs-number">50</span>))
scribble_rect = scribble_icon.get_rect().move((<span class="hljs-number">130</span>,<span class="hljs-number">120</span>))

weather_icon = pygame.image.load(<span class="hljs-string">"img/weather_icon.png"</span>)
weather_icon = pygame.transform.scale(weather_icon, (<span class="hljs-number">50</span>,<span class="hljs-number">50</span>))
weather_rect = weather_icon.get_rect().move(<span class="hljs-number">220</span>,<span class="hljs-number">120</span>)

home_icon = pygame.image.load(<span class="hljs-string">"img/home_icon.png"</span>)
home_icon = pygame.transform.scale(home_icon, (<span class="hljs-number">50</span>,<span class="hljs-number">50</span>))
home_rect = home_icon.get_rect().move(<span class="hljs-number">40</span>,<span class="hljs-number">0</span>)

clear_icon = pygame.image.load(<span class="hljs-string">"img/clear_icon.png"</span>)
clear_icon = pygame.transform.scale(clear_icon, (<span class="hljs-number">50</span>,<span class="hljs-number">50</span>))
clear_rect = clear_icon.get_rect().move(<span class="hljs-number">40</span>,<span class="hljs-number">80</span>)

pause_rect_1 = pygame.Rect(<span class="hljs-number">148</span>,<span class="hljs-number">108</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)
pause_rect_2 = pygame.Rect(<span class="hljs-number">163</span>,<span class="hljs-number">108</span>,<span class="hljs-number">10</span>,<span class="hljs-number">30</span>)

spotify_surface.blit(home_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">0</span>))
play_button = pygame.draw.circle(spotify_surface, WHITE, (width<span class="hljs-comment">//2, height//2), 30)</span>

offset = <span class="hljs-number">80</span>
next_track_rect_1 = pygame.draw.polygon(spotify_surface, WHITE, ((<span class="hljs-number">147</span>+offset,<span class="hljs-number">135</span>),(<span class="hljs-number">147</span>+offset,<span class="hljs-number">105</span>),(<span class="hljs-number">177</span>+offset,<span class="hljs-number">120</span>)))
offset = <span class="hljs-number">105</span>
next_track_rect_2 = pygame.draw.polygon(spotify_surface, WHITE, ((<span class="hljs-number">147</span>+offset,<span class="hljs-number">135</span>),(<span class="hljs-number">147</span>+offset,<span class="hljs-number">105</span>),(<span class="hljs-number">177</span>+offset,<span class="hljs-number">120</span>)))

offset = <span class="hljs-number">80</span>
prev_track_rect_1 = pygame.draw.polygon(spotify_surface, WHITE, ((<span class="hljs-number">147</span>-offset,<span class="hljs-number">135</span>),(<span class="hljs-number">147</span>-offset,<span class="hljs-number">105</span>),(<span class="hljs-number">177</span>-offset<span class="hljs-number">-60</span>,<span class="hljs-number">120</span>)))
offset = <span class="hljs-number">55</span>
prev_track_rect_2 = pygame.draw.polygon(spotify_surface, WHITE, ((<span class="hljs-number">147</span>-offset,<span class="hljs-number">135</span>),(<span class="hljs-number">147</span>-offset,<span class="hljs-number">105</span>),(<span class="hljs-number">177</span>-offset<span class="hljs-number">-60</span>,<span class="hljs-number">120</span>)))

def draw_music_player():
    screen.fill(BLACK)
    <span class="hljs-keyword">if</span> not playing:
        pygame.draw.circle(spotify_surface, WHITE, (width<span class="hljs-comment">//2, height//2), 30)</span>
        pygame.draw.polygon(spotify_surface, BLACK, ((<span class="hljs-number">147</span>,<span class="hljs-number">135</span>),(<span class="hljs-number">147</span>,<span class="hljs-number">105</span>),(<span class="hljs-number">177</span>,<span class="hljs-number">120</span>)))
    elif playing:
        pygame.draw.circle(spotify_surface, WHITE, (width<span class="hljs-comment">//2, height//2), 30)</span>
        pygame.draw.rect(spotify_surface, BLACK, pause_rect_1)
        pygame.draw.rect(spotify_surface, BLACK, pause_rect_2)

    screen.blit(spotify_surface, (<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))
    pygame.display.flip()

def draw_home():
    global spotify_rect
    screen.fill(BLACK)
    home_surface.blit(spotify_icon, spotify_rect)
    home_surface.blit(scribble_icon, scribble_rect)
    home_surface.blit(weather_icon, weather_rect)
    screen.blit(home_surface,(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))
    pygame.display.flip()




# scribble helper 
def color_pallete():
    # init pallette surface, fill it and draw circles on it, return the surface and the circle rects
    pallete_surface = pygame.Surface((<span class="hljs-number">40</span>, <span class="hljs-number">240</span>))
    pallete_surface.fill(GREY)
    red_circle = pygame.draw.circle(pallete_surface, RED, (<span class="hljs-number">20</span>, <span class="hljs-number">20</span>), <span class="hljs-number">10</span>)
    orange_circle = pygame.draw.circle(pallete_surface, ORANGE, (<span class="hljs-number">20</span>, <span class="hljs-number">60</span>), <span class="hljs-number">10</span>)
    green_circle = pygame.draw.circle(pallete_surface, GREEN, (<span class="hljs-number">20</span>, <span class="hljs-number">100</span>), <span class="hljs-number">10</span>)
    blue_circle = pygame.draw.circle(pallete_surface, BLUE, (<span class="hljs-number">20</span>, <span class="hljs-number">140</span>), <span class="hljs-number">10</span>)
    purple_circle = pygame.draw.circle(pallete_surface, PURPLE, (<span class="hljs-number">20</span>, <span class="hljs-number">180</span>), <span class="hljs-number">10</span>)
    white_circle = pygame.draw.circle(pallete_surface, WHITE, (<span class="hljs-number">20</span>, <span class="hljs-number">220</span>), <span class="hljs-number">10</span>)
    return pallete_surface, red_circle, orange_circle, green_circle, blue_circle, purple_circle, white_circle

print(<span class="hljs-string">"setup pallete surface"</span>)
#--------- Setting up the surface and prepare to enter drawing mode -----------------  
pallete_surface, red_circle, orange_circle, green_circle, blue_circle, purple_circle, white_circle = color_pallete()
print(<span class="hljs-string">"finished setup pallete surface"</span>)

# init the draw surface
draw_surface = pygame.Surface((<span class="hljs-number">280</span>, <span class="hljs-number">240</span>))
draw_surface.fill(BLACK)

scribble_surface = pygame.Surface((<span class="hljs-number">320</span>,<span class="hljs-number">240</span>))

# blit and flip both
scribble_surface.blit(pallete_surface, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>))
scribble_surface.blit(draw_surface, (<span class="hljs-number">40</span>, <span class="hljs-number">0</span>))
scribble_surface.blit(home_icon, (<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))
scribble_surface.blit(clear_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">80</span>))
print(<span class="hljs-string">"finished setup pygame"</span>)

save_scribble = []
for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">64</span>):
    save_scribble.append([])
    for j <span class="hljs-keyword">in</span> range(<span class="hljs-number">32</span>):
        save_scribble[i].append(BLACK)

def GPIO19_callback(channel):
    print(<span class="hljs-string">"quit"</span>)
    global code_run
    code_run = <span class="hljs-literal">False</span>

GPIO.setmode(GPIO.BCM)
GPIO.setup(<span class="hljs-number">19</span>, GPIO.IN, GPIO.PUD_DOWN)
GPIO.add_event_detect(<span class="hljs-number">19</span>, GPIO.FALLING, callback = GPIO19_callback, bouncetime=<span class="hljs-number">300</span>)


def map_led_matrix(canvas, led_matrix):
    # canvas.Clear()
    for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">64</span>):
        for j <span class="hljs-keyword">in</span> range(<span class="hljs-number">32</span>):
            r,g,b = led_matrix[i][j]
            canvas.SetPixel(i,j,r,g,b)

################# weather page #####################
f = open(<span class="hljs-string">'weather.json'</span>)
weather_dict = json.load(f)
weather_dict_all = weather_dict
weather_dict = weather_dict[<span class="hljs-string">"current"</span>]
temp = weather_dict[<span class="hljs-string">"temp"</span>]
hum = <span class="hljs-string">'Hum:'</span> + str(weather_dict[<span class="hljs-string">"humidity"</span>]) + <span class="hljs-string">'%'</span>
current_weather =  weather_dict[<span class="hljs-string">"weather"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"main"</span>]
sunrise_utc = int(weather_dict[<span class="hljs-string">"sunrise"</span>]) + int(weather_dict_all[<span class="hljs-string">"timezone_offset"</span>])
sunset_utc = int(weather_dict[<span class="hljs-string">"sunset"</span>]) + int(weather_dict_all[<span class="hljs-string">"timezone_offset"</span>])
sun_condition = <span class="hljs-string">''</span>
print(sunrise_utc)
f.close()

time_now = datetime.now()
hour = int(time_now.strftime(<span class="hljs-string">"%H"</span>))
<span class="hljs-keyword">if</span> hour &lt; <span class="hljs-number">12</span>:
    sun_condition = datetime.utcfromtimestamp(sunrise_utc).strftime(<span class="hljs-string">'%H:%M'</span>)
    sun_condition = <span class="hljs-string">'Sunrise:'</span> + sun_condition
    weather_gif = [<span class="hljs-string">"sun.gif"</span>, <span class="hljs-string">"snow.gif"</span>, <span class="hljs-string">"rain.gif"</span>, <span class="hljs-string">"cloudy_day.gif"</span>]
else:
    sun_condition = datetime.utcfromtimestamp(sunset_utc).strftime(<span class="hljs-string">'%H:%M'</span>)
    sun_condition = <span class="hljs-string">'Sunset:'</span> + sun_condition
    weather_gif = [<span class="hljs-string">"moon.gif"</span>, <span class="hljs-string">"snow.gif"</span>, <span class="hljs-string">"rain.gif"</span>, <span class="hljs-string">"cloudy_night.gif"</span>]

weathers = [[<span class="hljs-string">"Clear"</span>],[<span class="hljs-string">"Snow"</span>], [<span class="hljs-string">"Rain"</span>, <span class="hljs-string">"Thunderstorm"</span>, <span class="hljs-string">"Drizzle"</span>],[<span class="hljs-string">"Clouds"</span>]]

gif = []
category_count = <span class="hljs-number">0</span>
found = <span class="hljs-literal">False</span>
while not found:
    for category <span class="hljs-keyword">in</span> weathers:
        for weather <span class="hljs-keyword">in</span> category:
            <span class="hljs-keyword">if</span> current_weather == weather:
                img = weather_gif[category_count]
                found = <span class="hljs-literal">True</span>
                break
        category_count += <span class="hljs-number">1</span>

<span class="hljs-keyword">with</span> Image.open(<span class="hljs-string">"img/"</span> + img) <span class="hljs-keyword">as</span> im:
    for frame <span class="hljs-keyword">in</span> ImageSequence.Iterator(im):
        frame_processed = frame.resize((<span class="hljs-number">64</span>,<span class="hljs-number">32</span>),Image.ANTIALIAS).convert(<span class="hljs-string">"RGB"</span>)
        gif.append(frame_processed)           

def update_album_cover(sp):
    my_spotify.download_curr_album_cover(sp)
    im = Image.open(<span class="hljs-string">"album_cover.jpg"</span>)
    album_cover = im.resize((<span class="hljs-number">26</span>,<span class="hljs-number">26</span>),Image.ANTIALIAS).convert(<span class="hljs-string">"RGB"</span>)
    return album_cover

################### LED ###########################
<span class="hljs-keyword">class</span> Dashboard(SampleBase):
    def __init__(self, *args, **kwargs):
        super(Dashboard, self).__init__(*args, **kwargs)

    def run(self):
        print(<span class="hljs-string">"running dashboard"</span>)
        canvas = self.matrix

        font = graphics.Font()

        time_now = datetime.now()
        curr_date = time_now.strftime(<span class="hljs-string">"%m/%d/%Y"</span>)
        curr_time = time_now.strftime(<span class="hljs-string">"%H:%M"</span>)

        font.LoadFont(<span class="hljs-string">"../rpi-rgb-led-matrix/fonts/4x6.bdf"</span>)

        # graphics.DrawText(canvas, font, <span class="hljs-number">22</span>, <span class="hljs-number">10</span>, led_white, curr_date)
        # graphics.DrawText(canvas, font, <span class="hljs-number">30</span>, <span class="hljs-number">20</span>, led_white, curr_time)
        # graphics.DrawText(canvas, font, <span class="hljs-number">22</span>, <span class="hljs-number">28</span>, led_white, greeting)

        # hour = int(time_now.strftime(<span class="hljs-string">"%H"</span>))
        # greeting = <span class="hljs-string">""</span>
        # <span class="hljs-keyword">if</span> (hour &gt;= <span class="hljs-number">5</span> and hour &lt; <span class="hljs-number">12</span>):
        #     greeting = <span class="hljs-string">"Good morning"</span>
        # elif (hour &gt;= <span class="hljs-number">12</span> and hour &lt; <span class="hljs-number">18</span>):
        #     greeting = <span class="hljs-string">"Good afternoon"</span>
        # elif (hour &gt;= <span class="hljs-number">18</span> and hour &lt; <span class="hljs-number">22</span>):
        #     greeting = <span class="hljs-string">"Good evening"</span>
        # else:
        #     greeting = <span class="hljs-string">"Good night"</span>

        # my_spotify.download_curr_album_cover(sp)
        # im = Image.open(<span class="hljs-string">"album_cover.jpg"</span>)
        # album_cover = im.resize((<span class="hljs-number">26</span>,<span class="hljs-number">26</span>),Image.ANTIALIAS).convert(<span class="hljs-string">"RGB"</span>)



        start_time = time.time()

        global is_home
        global is_music_player
        global is_scribble
        global is_weather
        global drawing
        global sp
        global code_run
        global playing
        global brush_color

        album_cover = update_album_cover(sp)
        track_name, artist = my_spotify.get_curr_track_info(sp)
        print(<span class="hljs-string">"running while loop"</span>)

        while(code_run):
                # print(str(code_run))
            try:
                for event <span class="hljs-keyword">in</span> pygame.event.get():
                    <span class="hljs-keyword">if</span> (event.type == pygame.KEYUP and event.key == pygame.K_c and event.mod &amp; pygame.KMOD_CTRL):
                        print(<span class="hljs-string">"quit event"</span>)
                        img = Image.new(<span class="hljs-string">'RGB'</span>, (<span class="hljs-number">64</span>,<span class="hljs-number">32</span>))
                        for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">64</span>):
                            for j <span class="hljs-keyword">in</span> range(<span class="hljs-number">32</span>):
                                img.putpixel((i,j),save_scribble[i][j])
                        img.save(<span class="hljs-string">"output.png"</span>)
                        pygame.quit()
                        sys.exit()

                    <span class="hljs-keyword">if</span> event.type == pygame.MOUSEBUTTONUP:
                        mouse_pos = pygame.mouse.get_pos()

                        <span class="hljs-keyword">if</span> is_home:
                            <span class="hljs-keyword">if</span> spotify_rect.collidepoint(mouse_pos):
                                is_music_player = <span class="hljs-literal">True</span>
                                is_home = <span class="hljs-literal">False</span>
                                is_scribble = <span class="hljs-literal">False</span>

                                album_cover = update_album_cover(sp)
                                track_name, artist = my_spotify.get_curr_track_info(sp)

                            elif scribble_rect.collidepoint(mouse_pos):
                                is_music_player = <span class="hljs-literal">False</span>
                                is_home = <span class="hljs-literal">False</span>
                                is_scribble = <span class="hljs-literal">True</span>

                            elif weather_rect.collidepoint(mouse_pos):
                                is_home = <span class="hljs-literal">False</span>
                                is_weather = <span class="hljs-literal">True</span>
                                print(<span class="hljs-string">"detected is weather"</span>)

                        elif is_music_player:
                            <span class="hljs-keyword">if</span> (play_button.collidepoint(mouse_pos)):
                                <span class="hljs-keyword">if</span> not playing:
                                    sp.start_playback()
                                    playing = <span class="hljs-literal">True</span>
                                else:
                                    sp.pause_playback()
                                    playing = <span class="hljs-literal">False</span>

                            elif(home_rect.collidepoint(mouse_pos)):
                                is_music_player = <span class="hljs-literal">False</span>
                                is_home = <span class="hljs-literal">True</span>

                            elif (next_track_rect_1.collidepoint(mouse_pos) or next_track_rect_2.collidepoint(mouse_pos)):
                                sp.next_track()
                                playing = <span class="hljs-literal">True</span>
                                # my_spotify.download_curr_album_cover(sp)
                                album_cover = update_album_cover(sp)
                                track_name, artist = my_spotify.get_curr_track_info(sp)


                            elif (prev_track_rect_1.collidepoint(mouse_pos) or prev_track_rect_2.collidepoint(mouse_pos)):
                                sp.next_track()
                                playing = <span class="hljs-literal">True</span>
                                # my_spotify.download_curr_album_cover(sp)
                                album_cover = update_album_cover(sp)
                                track_name, artist = my_spotify.get_curr_track_info(sp)

                        elif is_scribble:
                            <span class="hljs-keyword">if</span> home_rect.collidepoint(mouse_pos):
                                is_home = <span class="hljs-literal">True</span>
                                is_scribble = <span class="hljs-literal">False</span>
                            elif clear_rect.collidepoint(mouse_pos):
                                canvas.Clear()
                                for i <span class="hljs-keyword">in</span> range(<span class="hljs-number">64</span>):
                                    for j <span class="hljs-keyword">in</span> range(<span class="hljs-number">32</span>):
                                        save_scribble[i][j] = BLACK
                                draw_surface.fill(BLACK)
                                screen.blit(draw_surface, (<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))
                                screen.blit(pallete_surface,(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>))
                                screen.blit(home_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">0</span>))
                                screen.blit(clear_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">80</span>))
                                pygame.display.flip()
                            <span class="hljs-keyword">if</span> (red_circle.collidepoint(mouse_pos)):
                                brush_color = RED
                            elif (green_circle.collidepoint(mouse_pos)):
                                brush_color = GREEN
                            elif (blue_circle.collidepoint(mouse_pos)):
                                brush_color = BLUE
                            elif (white_circle.collidepoint(mouse_pos)):
                                brush_color = WHITE
                            elif(orange_circle.collidepoint(mouse_pos)):
                                brush_color = ORANGE
                            elif(purple_circle.collidepoint(mouse_pos)):
                                brush_color = PURPLE
                            else: 
                                drawing = <span class="hljs-literal">False</span>

                        elif is_weather:
                            <span class="hljs-keyword">if</span> home_rect.collidepoint(mouse_pos):
                                is_home = <span class="hljs-literal">True</span>
                                is_weather = <span class="hljs-literal">False</span>

                    elif event.type == pygame.MOUSEBUTTONDOWN and is_scribble:
                        drawing = <span class="hljs-literal">True</span>

################################ TFT Screen ########################################
                <span class="hljs-keyword">if</span> is_music_player:
                    draw_music_player()
                elif is_home:
                    draw_home()
                elif is_scribble:
                    screen.fill(BLACK)
                    <span class="hljs-keyword">if</span> drawing:
                        mouse_pos = pygame.mouse.get_pos()
                        save_scribble[int(mouse_pos[<span class="hljs-number">0</span>]/<span class="hljs-number">5</span>)][int(mouse_pos[<span class="hljs-number">1</span>]/<span class="hljs-number">7.5</span>)] = brush_color
                        draw_surface.set_at(mouse_pos, brush_color)
                    screen.blit(draw_surface, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>))
                    screen.blit(pallete_surface, (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>))
                    screen.blit(home_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">0</span>))
                    screen.blit(clear_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">80</span>))
                    pygame.display.flip()

                elif is_weather:
                    screen.fill(BLACK)
                    screen.blit(home_icon, (<span class="hljs-number">40</span>,<span class="hljs-number">0</span>))
                    pygame.display.flip()

##################################################################################
                <span class="hljs-keyword">if</span>(is_home):
                    time_now = datetime.now()
                    curr_date = time_now.strftime(<span class="hljs-string">"%m/%d/%Y"</span>)
                    curr_time = time_now.strftime(<span class="hljs-string">"%H:%M"</span>)

                    hour = int(time_now.strftime(<span class="hljs-string">"%H"</span>))
                    greeting = <span class="hljs-string">""</span>
                    <span class="hljs-keyword">if</span> (hour &gt;= <span class="hljs-number">5</span> and hour &lt; <span class="hljs-number">12</span>):
                        greeting = <span class="hljs-string">"Good morning"</span>
                    elif (hour &gt;= <span class="hljs-number">12</span> and hour &lt; <span class="hljs-number">18</span>):
                        greeting = <span class="hljs-string">"Good afternoon"</span>
                    elif (hour &gt;= <span class="hljs-number">18</span> and hour &lt; <span class="hljs-number">22</span>):
                        greeting = <span class="hljs-string">"Good evening"</span>
                    else:
                        greeting = <span class="hljs-string">"Good night"</span>

                    bear = Image.open(<span class="hljs-string">"img/bear.png"</span>)
                    bear = bear.resize((<span class="hljs-number">32</span>,<span class="hljs-number">32</span>),Image.ANTIALIAS).convert(<span class="hljs-string">"RGB"</span>)

                    canvas.Clear()
                    canvas.SetImage(bear, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>)
                    graphics.DrawText(canvas, font, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>, led_white, curr_date)
                    graphics.DrawText(canvas, font, <span class="hljs-number">2</span>, <span class="hljs-number">20</span>, led_white, curr_time)
                    graphics.DrawText(canvas, font, <span class="hljs-number">2</span>, <span class="hljs-number">30</span>, led_white, greeting)

                elif is_music_player:
                    canvas.Clear()
                    canvas.SetImage(album_cover, <span class="hljs-number">3</span>,<span class="hljs-number">3</span>)
                    graphics.DrawText(canvas, font, <span class="hljs-number">30</span>, <span class="hljs-number">10</span>, led_white, track_name)    
                    graphics.DrawText(canvas, font, <span class="hljs-number">30</span>, <span class="hljs-number">20</span>, led_white, artist)     

                elif is_scribble:
                    canvas.Clear()
                    map_led_matrix(canvas, save_scribble)

                elif is_weather:
                    canvas.Clear()

                    for frame <span class="hljs-keyword">in</span> gif[<span class="hljs-number">0</span>:<span class="hljs-number">10</span>]:
                        <span class="hljs-keyword">if</span> not is_weather:
                            break
                        # canvas.SetImage(image, <span class="hljs-number">0</span>,<span class="hljs-number">15</span>)
                        canvas.SetImage(frame, <span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
                        graphics.DrawText(canvas, font, <span class="hljs-number">2</span>, <span class="hljs-number">18</span>, led_white, current_weather)
                        graphics.DrawText(canvas, font, <span class="hljs-number">2</span>, <span class="hljs-number">25</span>, led_white, hum)
                        graphics.DrawText(canvas, font, <span class="hljs-number">2</span>, <span class="hljs-number">31</span>, led_white, sun_condition)

                        time.sleep(<span class="hljs-number">0.1</span>)



                time.sleep(<span class="hljs-number">0.05</span>)

            except KeyboardInterrupt:
                print(<span class="hljs-string">"keyboard interrupt"</span>)
                code_run = <span class="hljs-literal">False</span>
                break

        print(<span class="hljs-string">"exit while loop"</span>)
        canvas.Clear()
        GPIO.cleanup()
        pygame.display.quit()
        return
        # pygame.quit()
        # sys.exit()
        # quit() 

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    print(<span class="hljs-string">"enter main"</span>)
    graphics_test = Dashboard()
    <span class="hljs-keyword">if</span> (not graphics_test.process()):
        graphics_test.print_help()
</code></pre>
<p>Below is the Spotify API code where we defined our own functions to help us download album cover, switch between
    songs, and pulling song infos.</p>
<pre><code class="lang-python">import spotipy
from spotipy.oauth2 import SpotifyOAuth
import json
import requests
import os

#set environment variables
os.<span class="hljs-built_in">system</span>(<span class="hljs-string">"export CLIENT_ID=CLIENT_ID_PLACEHOLDER"</span>)
os.<span class="hljs-built_in">system</span>(<span class="hljs-string">"export CLIENT_SECRET=CLIENT_SECRET_PLACEHOLDER"</span>)
os.<span class="hljs-built_in">system</span>(<span class="hljs-string">"export REDIRECT_URI=http://localhost:8080"</span>)

scope = <span class="hljs-string">"streaming,user-read-playback-state,user-library-read,user-modify-playback-state,app-remote-control"</span>

client_id = <span class="hljs-string">"CLIENT_ID_PLACEHOLDER"</span>
client_secret = <span class="hljs-string">"CLIENT_SECRET_PLACEHOLDER"</span>
redirect_url = <span class="hljs-string">"http://localhost:8080"</span>

def spotify_init():
    scope = <span class="hljs-string">"streaming,user-read-playback-state,user-library-read,user-modify-playback-state,app-remote-control"</span>
    <span class="hljs-keyword">sp</span> = spotipy.Spotify(auth_manager=SpotifyOAuth(scope=scope, client_id = client_id, client_secret = client_secret, redirect_uri = redirect_url, open_browser=False))
    device_id = <span class="hljs-keyword">sp</span>.devices()[<span class="hljs-string">"devices"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"id"</span>]
    <span class="hljs-keyword">sp</span>.transfer_playback(device_id)
    <span class="hljs-keyword">sp</span>.pause_playback()
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">sp</span>


def add_playlist_to_queue(<span class="hljs-keyword">sp</span>):
    playlist = <span class="hljs-keyword">sp</span>.current_user_playlists(limit = <span class="hljs-number">50</span>, offset = <span class="hljs-number">0</span>)[<span class="hljs-string">"items"</span>][<span class="hljs-number">0</span>]
    play_list_id = playlist[<span class="hljs-string">"id"</span>]
    <span class="hljs-built_in">items</span> = <span class="hljs-keyword">sp</span>.playlist_items(play_list_id)
    tracks = <span class="hljs-built_in">items</span>[<span class="hljs-string">"items"</span>]
    num_songs = <span class="hljs-built_in">len</span>(tracks)
    first_id = tracks[<span class="hljs-number">0</span>][<span class="hljs-string">"track"</span>][<span class="hljs-string">"id"</span>]
    <span class="hljs-keyword">for</span> track in track<span class="hljs-variable">s:</span>
        track_id = track[<span class="hljs-string">"track"</span>][<span class="hljs-string">"id"</span>]
        <span class="hljs-keyword">sp</span>.add_to_queue(track_id)
    # <span class="hljs-keyword">while</span>(<span class="hljs-keyword">sp</span>.queue()[<span class="hljs-string">"currently_playing"</span>][<span class="hljs-string">"id"</span>] != first_id):
    #     <span class="hljs-keyword">sp</span>.next_track()

    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">sp</span>.start_playback()
    excep<span class="hljs-variable">t:</span>
        pass
    download_curr_album_cover(<span class="hljs-keyword">sp</span>)
    # <span class="hljs-keyword">sp</span>.seek_track(<span class="hljs-number">0</span>)


def download_curr_album_cover(<span class="hljs-keyword">sp</span>):
    album_cover_url = <span class="hljs-keyword">sp</span>.current_playback()[<span class="hljs-string">"item"</span>][<span class="hljs-string">"album"</span>][<span class="hljs-string">"images"</span>][-<span class="hljs-number">1</span>][<span class="hljs-string">"url"</span>]
    response = requests.<span class="hljs-built_in">get</span>(album_cover_url)
    with <span class="hljs-keyword">open</span>(<span class="hljs-string">"album_cover.jpg"</span>, <span class="hljs-string">'wb'</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">f</span>:
        <span class="hljs-keyword">f</span>.<span class="hljs-keyword">write</span>(response.content)



def get_curr_track_info(<span class="hljs-keyword">sp</span>):
    curr_playback = <span class="hljs-keyword">sp</span>.current_playback()
    artist = curr_playback[<span class="hljs-string">"item"</span>][<span class="hljs-string">"artists"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"name"</span>]
    track_name = curr_playback[<span class="hljs-string">"item"</span>][<span class="hljs-string">"name"</span>]
    <span class="hljs-keyword">return</span> track_name, artist

# <span class="hljs-keyword">print</span>(json.dumps(<span class="hljs-keyword">sp</span>.current_playback(), <span class="hljs-built_in">indent</span> = <span class="hljs-number">4</span>))
<span class="hljs-keyword">sp</span> = spotify_init()
add_playlist_to_queue(<span class="hljs-keyword">sp</span>)
<span class="hljs-keyword">print</span>(get_curr_track_info(<span class="hljs-keyword">sp</span>))
</code></pre>